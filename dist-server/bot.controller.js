var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,r){void 0===r&&(r=s);var o=Object.getOwnPropertyDescriptor(t,s);o&&("get"in o?t.__esModule:!o.writable&&!o.configurable)||(o={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,r,o)}:function(e,t,s,r){e[r=void 0===r?s:r]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||(()=>{var o=function(e){return(o=Object.getOwnPropertyNames||function(e){var t,s=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(s[s.length]=t);return s})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s=o(e),r=0;r<s.length;r++)"default"!==s[r]&&__createBinding(t,e,s[r]);return __setModuleDefault(t,e),t}})(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BotAvatar=void 0;let DEBUG_WEEK_DAYS_PERIODS=!1,test_run_counter_week=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],test_run_counter_period=["Morning","Late Night"],weekdayCounter=0,dayPeriodCounter=0,ragSystem_1=require("./ragSystem"),chains_1=require("langchain/chains"),groq_1=require("@langchain/groq"),prompts_1=require("@langchain/core/prompts"),prompts_2=require("@langchain/core/prompts"),memory_1=require("langchain/memory"),openai_1=require("@langchain/openai"),memory_2=require("langchain/memory"),messages_1=require("@langchain/core/messages"),botConfig=__importStar(require("./config")),botPrompts=__importStar(require("./botPrompts")),FileLogger_1=__importDefault(require("./lib/FileLogger")),IMG_URL_REGEX=/(http(s?):)([/|.|\w|\s|-])*\.(?:jpg|gif|png)/,WEEKDAYS=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];class BotAvatar{constructor(e,t){this.userMemories=new Map,this.eventBus=e,this.farcaster=t,this.eventBus.subscribe("CAST_ADD",e=>this.handleCastAddMessage(e)),this.eventBus.subscribe("WAS_MENTIONED",e=>this.handleMention(e)),this.eventBus.subscribe("WAS_REPLIED",e=>this.handleReply(e)),this.eventBus.subscribe("CHANNEL_NEW_MESSAGE",e=>this.handleChannelNewMessage(e)),this.messagesLog=new FileLogger_1.default({folder:"./logs-messages",printconsole:!0}),this.memoryLog=new FileLogger_1.default({folder:"./logs-memory",printconsole:!0}),this.newCasts=new FileLogger_1.default({folder:"./logs-newcasts",printconsole:!0}),this.userMemories=new Map,this.MESSAGES_HISTORY_SIZE=botConfig.MESSAGES_HISTORY_SIZE,this.MEMORY_EXPIRATION_MIN=60*botConfig.MEMORY_EXPIRATION_MIN*1e3,this.updateInternalClockTime(),this.botLLM=new groq_1.ChatGroq({temperature:.7,model:botConfig.BotLLMModel,stop:null}),this.assistentLLM=new groq_1.ChatGroq({temperature:.7,model:botConfig.AssistentModel,stop:null});e=prompts_1.ChatPromptTemplate.fromMessages([["system",botPrompts.BOT_SYSTEM_PROMPT],["human","{userquery}"]]);this.chatChain=new chains_1.ConversationChain({memory:null,prompt:e,llm:this.botLLM}),setInterval(()=>this.cleanupOldMemories.call(this),60*botConfig.MEMORY_CLEANUP_MIN*1e3),setInterval(()=>this.getFarcasaterTrendingFeed(),60*botConfig.FARCASTER_TRENDING_MIN*1e3),this.stringPromptMemory=new memory_1.BufferMemory({returnMessages:!0,memoryKey:"history",inputKey:"userquery"})}async preloadNotionDocuments(){return console.log("Loading Notions Documents..."),console.time("Document Load Time"),ragSystem_1.ragSystem.preloadDocuments().then(e=>(console.log(`Documents loaded successfully. Created ${e} vector chunks.`),console.timeEnd("Document Load Time"),!0)).catch(()=>(console.error("Failed loading documents. Please restart service."),console.timeEnd("Document Load Time"),!1)),!1}cleanupOldMemories(){var e,t,s=Date.now();for([e,t]of this.userMemories.entries())s-t.lastInteraction>this.MEMORY_EXPIRATION_MIN&&(this.userMemories.delete(e),this.messagesLog.log("","MEM_CLEAN_UP"),this.messagesLog.log(`Memory for user ${e} removed due to inactivity.`,"MEM_CLEAN_UP"),this.messagesLog.log("","MEM_CLEAN_UP"))}async sumarizeUserHistoryMemory(t){let s=this.userMemories.get(t);var r=await s.memory.loadMemoryVariables({});if(r.history.length>this.MESSAGES_HISTORY_SIZE){console.warn("User "+t+" Memory is "+r.history.length);r=await r.history,r=(0,messages_1.filterMessages)(r,{includeTypes:[messages_1.AIMessage,messages_1.HumanMessage]}).map(e=>(e instanceof messages_1.AIMessage?botConfig.BotName:e instanceof messages_1.HumanMessage?t:"Unknown")+": "+e.content).join("\n");let e=await this.assistentLLM.invoke([{role:"system",content:`Summarize these conversation between Tom and ${t} as concise first-person insights in 5 sentences max.
Remember: omit any introductory phrases or explanations:
${r}
Summary:`}]);r=t+"_Summary";this.messagesLog.log("",r),this.messagesLog.log("SummaryResponse for "+t,r),this.messagesLog.log(e.content,r),this.messagesLog.log("",r),s.memory.clear().then(()=>{s.memory.chatHistory.addUserMessage(e.content)})}}async addtoUserMemory(e,t,s){e=this.userMemories.get(e);e.memory&&(await e.memory.chatHistory.addUserMessage(t),await e.memory.chatHistory.addAIChatMessage(s))}async getCombinedMemory(e,t){var s=new memory_1.BufferMemory({memoryKey:"chat_history_lines",inputKey:"userquery"}),r=new memory_2.ConversationSummaryMemory({llm:new openai_1.ChatOpenAI({model:"gpt-3.5-turbo",temperature:0,apiKey:botConfig.OPENAI_API_KEY}),inputKey:"userquery",memoryKey:"conversation_summary"});return new memory_2.CombinedMemory({memories:[s,r]})}async getRelevantUserMemory(e,t){this.userMemories.has(e)||(s={memory:new memory_1.BufferMemory({returnMessages:!0,memoryKey:"history",inputKey:"userquery"}),lastInteraction:Date.now()},this.userMemories.set(e,s));var s=this.userMemories.get(e),e=(s.lastInteraction=Date.now(),await s.memory.loadMemoryVariables({}));let r=t.split(" ");s=e.history.filter(t=>r.some(e=>t.content.toLowerCase().includes(e.toLowerCase()))),t=new memory_1.BufferMemory({returnMessages:!0,memoryKey:"history",inputKey:"userquery"});return await t.chatHistory.addMessages(s),t}getCurrentUserMemory(e){var t,s;return this.userMemories.has(e)?this.userMemories.get(e).memory:(s={memory:t=new memory_1.BufferMemory({returnMessages:!0,memoryKey:"history",inputKey:"userquery"}),lastInteraction:Date.now()},this.userMemories.set(e,s),t)}async trimMemoryHistory(e){(await this.stringPromptMemory.loadMemoryVariables({})).length>this.MESSAGES_HISTORY_SIZE&&(await this.stringPromptMemory.clear(),await this.stringPromptMemory.chatHistory.addAIChatMessage(e.toString()))}async printMemorySummary(){setInterval(async()=>{var e=await this.stringPromptMemory.loadMemoryVariables({});this.memoryLog.log("MEMORYSUMMARY:","MemUsed"),this.memoryLog.log(e,"MEMORYSUMMARY")},3e5)}async summarizeTrendingFeed(e){try{var t=botPrompts.WHATS_IS_TRENDING+e,s=(this.stringPromptMemory.chatHistory.addMessage(new messages_1.AIMessage({content:t,id:"tom",name:"tom"})),await this.assistentLLM.invoke([{role:"user",content:t}]));return s.content}catch(e){console.error("Error summarizing conversation:",e)}}async summarizeConversationHumans(){try{var e=await this.stringPromptMemory.chatHistory.getMessages(),t=`Summarize what users are talking about:
`+(0,messages_1.filterMessages)(e,{includeTypes:[messages_1.HumanMessage]}).map(e=>e.name+": "+e.content).join("\n");return(await this.assistentLLM.invoke([{role:"user",content:t}])).content}catch(e){console.error("Error summarizing conversation:",e)}}async summarizeConversationTom(){try{var e=await this.stringPromptMemory.chatHistory.getMessages(),t=`Summarize this messages in first person insights:
`+(0,messages_1.filterMessages)(e,{includeTypes:[messages_1.AIMessage,messages_1.HumanMessage]}).map(e=>e.name+": "+e.content).join("\n");return(await this.assistentLLM.invoke([{role:"user",content:t}])).content}catch(e){console.error("Error summarizing conversation:",e)}}async summarizeConversation(){try{var e=await this.stringPromptMemory.chatHistory.getMessages(),t=`Summarize the following conversation:
`+(0,messages_1.filterMessages)(e,{includeTypes:[messages_1.AIMessage]}).slice(-10).map(e=>e.name+": "+e.content).join("\n");return(await this.assistentLLM.invoke([{role:"user",content:t}])).content}catch(e){console.error("Error summarizing conversation:",e)}}async getFarcasaterTrendingFeed(){var e,t=await this.farcaster.getTrendingFeed(),t=await this.summarizeTrendingFeed(t);t&&(e={name:botConfig.BotName,message:t},this.lastTrendingSummary=t,this.eventBus.publish("PRINT_MSG",e))}countWords(e){return e.trim().split(/\s+/).filter(e=>0<e.length).length}isQuestion(e){return e.includes("?")}shouldReply(e){var t=this.countWords(e);return!(!this.isQuestion(e)&&t<botConfig.MIN_REPLY_WORD_COUNT&&(console.log(`Not a question and too small (${t} < ${botConfig.MIN_REPLY_WORD_COUNT}). STOP!
"`+e),1))}async replyMessage(e,t){var s={configurable:{thread_id:e+"_thread"}};if("System-uuid-bot"==e)return{name:botConfig.BotName,message:"Hi, how can I assist you today?"};let r="";var o=await ragSystem_1.ragSystem.invokeRAG(e,t).catch(e=>{console.error("Failed to generate RAG response",e)}),o=(o&&o.generatedAnswer&&(r=o.generatedAnswer),this.chatChain.memory=await this.getRelevantUserMemory(e,t),await this.chatChain.invoke({context:r,userquery:t},s)),s="MESSAGES";return this.messagesLog.log("",s),this.messagesLog.log(`@${e}: `+t,s),this.messagesLog.log("@nounspacetom: "+o.response,s),this.messagesLog.log("",s),this.messagesLog.log("",s),await this.addtoUserMemory(e,t,o.response),await this.sumarizeUserHistoryMemory(e),{name:botConfig.BotName,message:o.response}}async handleCastAddMessage(e){var t,e=e.body.textWithMentions;this.stringPromptMemory.chatHistory.addMessage(new messages_1.AIMessage({content:e,id:botConfig.BotName,name:botConfig.BotName})),botConfig.LOG_MESSAGES&&(this.newCasts.log("",t="NEW_CAST"),this.newCasts.log("NEW_CAST:",t),this.newCasts.log("",t),this.newCasts.log(e,t),this.newCasts.log("",t))}async handleReply(e){var t,s;this.shouldReply(e.body.textWithMentions)&&(t={name:e.fName,message:e.body.textWithMentions},s=await this.replyMessage(e.fName,e.body.textWithMentions),this.eventBus.publish("PRINT_MSG",t),this.eventBus.publish("PRINT_MSG",s),this.farcaster.publishUserReply(s.message,e.hash,e.fid))}async handleMention(e){var t={name:e.fName,message:e.body.textWithMentions},s=await this.replyMessage(e.fName,e.body.textWithMentions);this.eventBus.publish("PRINT_MSG",t),this.eventBus.publish("PRINT_MSG",s),this.farcaster.publishUserReply(s.message,e.hash,e.fid)}async handleChannelNewMessage(e){var t,s;this.shouldReply(e.body.textWithMentions)&&(t={name:e.fName,message:e.body.textWithMentions},s=await this.replyMessage(e.fName,e.body.textWithMentions),this.eventBus.publish("PRINT_MSG",t),this.eventBus.publish("PRINT_MSG",s),this.farcaster.publishUserReply(s.message,e.hash,e.fid))}async socialMediaSugestion(e,t){t=await prompts_2.PromptTemplate.fromTemplate(botPrompts.SOCIAL_MEDIA_MANAGER_SUGESTION).format({trending:t,summary:e,todaycontext:botPrompts.CAST_WEEK_PROMPT[this.weekday]}),e=[{role:"system",content:botPrompts.SOCIAL_MEDIA_MANAGER},{role:"user",content:t}];return this.assistentLLM.invoke(e)}async getTomNewMessage(e){e=[{role:"system",content:botPrompts.BOT_NEW_CAST_SYSTEM},{role:"user",content:e}];return this.botLLM.invoke(e)}formatTimeOfDay(e){return 6<=e&&e<12?"morning":12<=e&&e<18?"afternoon":18<=e&&e<24?"night":0<=e&&e<3?"late night":"early morning"}formatDateWithOrdinal(e){var t=e.getDate();return["January","February","March","April","May","June","July","August","September","October","November","December"][e.getMonth()]+" "+t+((e=t)%10==1&&11!==e?"st":e%10==2&&12!==e?"nd":e%10==3&&13!==e?"rd":"th")}async updateInternalClockTime(e=botConfig.TIMEZONE){this.agora=new Date;this.nowis=this.agora.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",timeZone:e}),this.today=this.formatDateWithOrdinal(new Date(this.agora.toLocaleString("en-US",{timeZone:e})));e=new Date(this.agora.toLocaleString("en-US",{timeZone:e}));this.hour=e.getHours(),this.weekday=WEEKDAYS[e.getDay()],this.dayPeriod=this.formatTimeOfDay(this.hour)}async displayInternalClock(){this.updateInternalClockTime(),console.warn(`
    ⌐◨-◨
    ⌐◨-◨  ⌐◨-◨  ⌐◨-◨
    ⌐◨-◨  ⌐◨-◨  ⌐◨-◨  ⌐◨-◨  ⌐◨-◨
    ⌐◨-◨  ⌐◨-◨  ⌐◨-◨  ⌐◨-◨  ⌐◨-◨  ⌐◨-◨  ⌐◨-◨

    Greetings from ${botConfig.BotName}!
    Today is ${this.weekday}, ${this.today}.
    It's currently ${this.nowis}, and we're in the ${this.dayPeriod}.
    Hope you're having a great day!`)}fakeTodaySpaceTime(){var e=test_run_counter_week[weekdayCounter],t=test_run_counter_period[dayPeriodCounter];this.weekday=e,this.dayPeriod=t,++dayPeriodCounter>=test_run_counter_period.length&&(dayPeriodCounter=0,weekdayCounter++),weekdayCounter>=test_run_counter_week.length&&(weekdayCounter=0)}async castNewMessagetoChannel(){this.updateInternalClockTime(),DEBUG_WEEK_DAYS_PERIODS&&this.fakeTodaySpaceTime(),void 0===this.lastTrendingSummary&&await this.getFarcasaterTrendingFeed();var e,t=await this.summarizeConversation(),s=await this.socialMediaSugestion(t,this.lastTrendingSummary),r=botPrompts.BOT_NEW_CAST_PROMPT,r=await prompts_2.PromptTemplate.fromTemplate(r).format({today:this.today,dayPeriod:this.dayPeriod,suggestion:s.content}),r=(await this.getTomNewMessage(r)).content;if(""!==r)return this.stringPromptMemory.chatHistory.addMessage(new messages_1.AIMessage({content:r,id:botConfig.BotName,name:botConfig.BotName})),r={name:botConfig.BotName,message:r},botConfig.LOG_MESSAGES&&(e=this.weekday,this.newCasts.log("",e),this.newCasts.log("",e),this.newCasts.log("CAST_NEW_MESSAGE "+this.weekday+" "+this.dayPeriod,e),this.newCasts.log("SMM: "+s.content,e),this.newCasts.log("",e),this.newCasts.log(r.name+": "+r.message,e),this.newCasts.log("",e)),await this.trimMemoryHistory(t),r}}exports.BotAvatar=BotAvatar;