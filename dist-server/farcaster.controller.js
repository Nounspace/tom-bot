var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,a,s){void 0===s&&(s=a);var n=Object.getOwnPropertyDescriptor(t,a);n&&("get"in n?t.__esModule:!n.writable&&!n.configurable)||(n={enumerable:!0,get:function(){return t[a]}}),Object.defineProperty(e,s,n)}:function(e,t,a,s){e[s=void 0===s?a:s]=t[a]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||(()=>{var n=function(e){return(n=Object.getOwnPropertyNames||function(e){var t,a=[];for(t in e)Object.prototype.hasOwnProperty.call(e,t)&&(a[a.length]=t);return a})(e)};return function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a=n(e),s=0;s<a.length;s++)"default"!==a[s]&&__createBinding(t,e,a[s]);return __setModuleDefault(t,e),t}})(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.Farcaster=void 0;let Reset="[0m",Blue="[34m",Green="[32m",Red="[31m",Yellow="[33m",Magenta="[35m",Italic="[3m",Underscore="[4m",Cyan="[36m",Gray="[90m",hub_nodejs_1=require("@farcaster/hub-nodejs"),nodejs_sdk_1=require("@neynar/nodejs-sdk"),neynarClient_1=__importDefault(require("./lib/neynarClient")),neverthrow_1=require("neverthrow"),hub_client_1=require("./lib/hub-client"),event_1=require("./api/event"),botConfig=__importStar(require("./config")),grapheme_splitter_1=__importDefault(require("grapheme-splitter")),node_util_1=require("node:util"),urlMatchesTargetChannel=t=>botConfig.TARGET_CHANNELS.some(e=>t.endsWith(e));class Farcaster{constructor(e){this.eventBus=e,this.USERS_FNAME_MAP=new Map,this.TARGET_FNAME_MAP=new Map,this.isConnected=!1,this.isReconnecting=!1,this.subscriberStream()}bytesToHex(e){return"0x"+Buffer.from(e).toString("hex")}hubProtocolToVerificationProtocol(e){if(e===hub_nodejs_1.Protocol.ETHEREUM)return"ethereum"}protocolBytesToString(e,t){switch(t){case hub_nodejs_1.Protocol.ETHEREUM:case"ethereum":return this.bytesToHex(e);default:throw new Error("Unexpected protocol: "+t)}}farcasterTimeToDate(e){if(void 0!==e){if(null===e)return null;e=(0,hub_nodejs_1.fromFarcasterTime)(e);if(e.isErr())throw e.error;return new Date(e.value)}}async insertMentions(t,a,s){let n=new grapheme_splitter_1.default;var r=n.splitGraphemes(t);s.map(e=>n.splitGraphemes(t.slice(0,e)).length);for(let e=a.length-1;0<=e;e--){var o=a[e],o=await this.handleUserFid(o),i=s[e];r.splice(i,0,"@"+o)}return r.join("")}convertProtobufMessageBodyToJson(e){let t,a,s;switch(null==(t=e.data)?void 0:t.type){case hub_nodejs_1.MessageType.CAST_ADD:if(!e.data.castAddBody)return void console.error("Missing castAddBody");var n,{embeds:r,mentions:o,mentionsPositions:i,text:d,parentCastId:c,parentUrl:h,type:l}=e.data.castAddBody,_=[];for(n of r)void 0!==n.castId?_.push(this.bytesToHex(n.castId.hash)):void 0!==n.url&&_.push(n.url);s={embeds:_,mentions:o,mentionsPositions:i,text:d,type:l,parent:c?{fid:c.fid,hash:this.bytesToHex(c.hash)}:h};break;case hub_nodejs_1.MessageType.CAST_REMOVE:if(!e.data.castRemoveBody)throw new Error("Missing castRemoveBody");r=e.data.castRemoveBody.targetHash;s={targetHash:this.bytesToHex(r)};break;case hub_nodejs_1.MessageType.REACTION_ADD:case hub_nodejs_1.MessageType.REACTION_REMOVE:if(!e.data.reactionBody)throw new Error("Missing reactionBody");if(e.data.reactionBody.targetCastId){var{type:o,targetCastId:{fid:i,hash:d}}=e.data.reactionBody;s={type:o,target:{fid:i,hash:this.bytesToHex(d)}}}else{if(!e.data.reactionBody.targetUrl)throw new Error("Missing targetCastId and targetUrl on reactionBody");var{type:l,targetUrl:c}=e.data.reactionBody;s={type:l,target:c}}break;case hub_nodejs_1.MessageType.LINK_ADD:case hub_nodejs_1.MessageType.LINK_REMOVE:if(!e.data.linkBody)throw new Error("Missing linkBody");if(!e.data.linkBody.targetFid)throw new Error("Missing linkBody target");var{type:h,targetFid:r,displayTimestamp:o}=e.data.linkBody;if(s={type:h,targetFid:r},o){i=(0,hub_nodejs_1.fromFarcasterTime)(o);if(i.isErr())throw i.error;s.displayTimestamp=i.value}break;case hub_nodejs_1.MessageType.LINK_COMPACT_STATE:if(!e.data.linkCompactStateBody)throw new Error("Missing linkCompactStateBody");var{type:d,targetFids:l}=e.data.linkCompactStateBody;s={type:d,targetFids:l};break;case hub_nodejs_1.MessageType.VERIFICATION_ADD_ETH_ADDRESS:if(!e.data.verificationAddAddressBody)throw new Error("Missing verificationAddAddressBody");var{address:c,claimSignature:h,blockHash:r,protocol:o}=e.data.verificationAddAddressBody;s={address:this.protocolBytesToString(c,o),claimSignature:this.protocolBytesToString(h,o),blockHash:this.protocolBytesToString(r,o),protocol:this.hubProtocolToVerificationProtocol(o)};break;case hub_nodejs_1.MessageType.VERIFICATION_REMOVE:if(!e.data.verificationRemoveBody)throw new Error("Missing verificationRemoveBody");var{address:i,protocol:d}=e.data.verificationRemoveBody;s={address:this.protocolBytesToString(i,d),protocol:this.hubProtocolToVerificationProtocol(d)};break;case hub_nodejs_1.MessageType.USER_DATA_ADD:if(!e.data.userDataBody)throw new Error("Missing userDataBody");var{type:l,value:c}=e.data.userDataBody;s={type:l,value:c};break;case hub_nodejs_1.MessageType.USERNAME_PROOF:if(!e.data.usernameProofBody)throw new Error("Missing usernameProofBody");var{timestamp:h,name:r,owner:o,signature:i,fid:d,type:l}=e.data.usernameProofBody;s={timestamp:h,name:this.bytesToHex(r),owner:this.bytesToHex(o),signature:this.bytesToHex(i),fid:d,type:l};break;default:throw new Error("Unknown message type "+(null==(a=e.data)?void 0:a.type))}return s}async subscriberStream(){var e=await hub_client_1.hubClient.subscribe({eventTypes:[hub_nodejs_1.HubEventType.MERGE_MESSAGE,hub_nodejs_1.HubEventType.PRUNE_MESSAGE,hub_nodejs_1.HubEventType.REVOKE_MESSAGE,hub_nodejs_1.HubEventType.MERGE_ON_CHAIN_EVENT]});e.isErr()?(console.error(e.error+"\nError starting stream"),this.reconnect()):e.match(e=>{this.isConnected=!0,console.info("Subscribed to Farcaster Stream: HEAD"),e.on("data",async e=>{this.handleEvent(e),(0,event_1.saveLatestEventId)(e.id),this.eventBus.publish("LAST_EVENT_ID",e.id)}),e.on("close",async()=>{this.isConnected=!1,console.warn("Hub stream closed"),console.log("Stream object details on CLOSE:"),this.logRelevantStreamDetails(e),this.reconnect()}),e.on("end",async()=>{this.isConnected=!1,console.warn("Hub stream ended"),console.log("Stream object details on END:"),this.logRelevantStreamDetails(e),this.reconnect()})},e=>{console.error(e,"Error streaming data.")})}logRelevantStreamDetails(t){let a={};["error","statusCode","closed","destroyed","_readableState","call"].forEach(e=>{e in t&&(a[e]=t[e])}),console.log("Filtered stream details:",(0,node_util_1.inspect)(a,{depth:2,colors:!0}))}reconnect(){this.isConnected||this.isReconnecting||(console.log("Reconnecting in 1 second..."),setTimeout(()=>{this.isReconnecting=!1,this.subscriberStream()},1e3))}async handleEvent(e){switch(e.type){case hub_nodejs_1.HubEventType.MERGE_MESSAGE:var t=e.mergeMessageBody.message;switch(t.data.type){case hub_nodejs_1.MessageType.CAST_ADD:this.handleAddCasts([t]);break;case hub_nodejs_1.MessageType.CAST_REMOVE:case hub_nodejs_1.MessageType.VERIFICATION_ADD_ETH_ADDRESS:case hub_nodejs_1.MessageType.VERIFICATION_REMOVE:case hub_nodejs_1.MessageType.USER_DATA_ADD:case hub_nodejs_1.MessageType.REACTION_ADD:case hub_nodejs_1.MessageType.REACTION_REMOVE:case hub_nodejs_1.MessageType.LINK_ADD:case hub_nodejs_1.MessageType.LINK_REMOVE:}break;case hub_nodejs_1.HubEventType.PRUNE_MESSAGE:switch(e.pruneMessageBody.message.data.type){case hub_nodejs_1.MessageType.CAST_ADD:case hub_nodejs_1.MessageType.REACTION_ADD:case hub_nodejs_1.MessageType.LINK_ADD:}break;case hub_nodejs_1.HubEventType.REVOKE_MESSAGE:break;case hub_nodejs_1.HubEventType.MERGE_ON_CHAIN_EVENT:switch(e.mergeOnChainEventBody.onChainEvent.type){case hub_nodejs_1.OnChainEventType.EVENT_TYPE_ID_REGISTER:case hub_nodejs_1.OnChainEventType.EVENT_TYPE_SIGNER:case hub_nodejs_1.OnChainEventType.EVENT_TYPE_STORAGE_RENT:}break;default:console.log("UNHANDLED HUB EVENT",e.id)}}async getTrendingFeed(e=nodejs_sdk_1.FilterType.GlobalTrending){let t="";try{var a,s=await neynarClient_1.default.fetchFeed(nodejs_sdk_1.FeedType.Filter,{filterType:e});for(a of Object.values(s.casts))t+=a.author.display_name+": "+a.text}catch(e){console.error("Error fetching Farcaster Feed",e)}return t}async publishToFarcaster(e,t){botConfig.LOG_MESSAGES,botConfig.PUBLISH_TO_FARCASTER?neynarClient_1.default.publishCast(botConfig.SIGNER_UUID,e,t).then(e=>{console.log(Yellow+"Cast published successfully: "+e.hash+Reset)}).catch(e=>{(0,nodejs_sdk_1.isApiErrorResponse)(e)?console.error(Red+e.response.data+Reset):console.error(Red+"Failed to publish cast: "+e+ +Reset)}):console.log(Yellow+"PUBLISH_TO_FARCASTER OFF"+Reset)}async publishUserReply(e,t,a){this.publishToFarcaster(e,{replyTo:t,parent_author_fid:a})}async publishNewChannelCast(e){var t={channelId:botConfig.CAST_TO_CHANNEL};this.publishToFarcaster(e,t)}async handleData_new(t){for(let e=0;e<t.length;e++){var a=t[e],s=this.convertProtobufMessageBodyToJson(a);if("text"in s&&"mentions"in s&&"mentionsPositions"in s&&s.mentions instanceof Array&&s.mentionsPositions instanceof Array){let e=s.text;0<s.mentions.length&&(e=await this.insertMentions(s.text,s.mentions,s.mentionsPositions)),s.textWithMentions=e;var n=await this.handleUserFid(a.data.fid);a.data.fid,a.data.type,this.farcasterTimeToDate(a.data.timestamp)}}}async handleAddCasts(t){for(let e=0;e<t.length;e++){var a=t[e].data;if(a.castAddBody){if(botConfig.TARGETS.includes(a.fid))return;if(a.castAddBody.parentCastId&&botConfig.TARGETS.includes(a.castAddBody.parentCastId.fid))return void this.handleReceivedReply(t[e]);var s=a.castAddBody.mentions.find(e=>botConfig.TARGETS.includes(e));if(s)return void this.handleMentioned(t[e],s);if(a.castAddBody.parentUrl&&urlMatchesTargetChannel(a.castAddBody.parentUrl))return void this.handleTargetChannelCast(t[e])}}}async handleUserFid(e){var t;return this.USERS_FNAME_MAP.has(e)||(t=await this.getFnameFromFid(e)).isOk()&&this.USERS_FNAME_MAP.set(e,t.value),this.USERS_FNAME_MAP.size>=botConfig.MAX_USER_CACHE&&this.USERS_FNAME_MAP.delete(this.USERS_FNAME_MAP.keys().next().value),this.USERS_FNAME_MAP.get(e)}async getFnameFromFid(e){var t=await hub_client_1.hubClient.getUserData({fid:e,userDataType:hub_nodejs_1.UserDataType.USERNAME});return(0,neverthrow_1.ok)(t.match(e=>(0,hub_nodejs_1.isUserDataAddMessage)(e)?e.data.userDataBody.value:"",()=>e+"!"))}async handleTargetFid(e){var t;return this.TARGET_FNAME_MAP.has(e)||(t=await this.getFnameFromFid(e)).isOk()&&this.TARGET_FNAME_MAP.set(e,t.value),this.TARGET_FNAME_MAP.get(e)}async handleTargetAddCast(e){this.convertProtobufMessageBodyToJson(e),await this.handleTargetFid(e.data.fid);e.data.castAddBody.parentCastId&&await this.handleUserFid(e.data.castAddBody.parentCastId.fid),e.data.castAddBody.text}async handleReceivedReply(e){await this.handleTargetFid(e.data.castAddBody.parentCastId.fid);e=await this.createCastObj(e);this.eventBus.publish("WAS_REPLIED",e)}async handleMentioned(e,t){await this.handleTargetFid(t);t=await this.createCastObj(e);this.eventBus.publish("WAS_MENTIONED",t)}async handleTargetChannelCast(e){e.data.castAddBody.parentUrl&&(e=await this.createCastObj(e),this.eventBus.publish("CHANNEL_NEW_MESSAGE",e))}async createCastObj(e){var t=this.convertProtobufMessageBodyToJson(e),a=await this.handleUserFid(e.data.fid),s=this.bytesToHex(e.hash);if("text"in t&&"mentions"in t&&"mentionsPositions"in t&&t.mentions instanceof Array&&t.mentionsPositions instanceof Array){let e=t.text;0<t.mentions.length&&(e=await this.insertMentions(t.text,t.mentions,t.mentionsPositions)),t.textWithMentions=e}return{fid:e.data.fid,fName:a,hash:s,type:e.data.type,timestamp:this.farcasterTimeToDate(e.data.timestamp),body:t}}}exports.Farcaster=Farcaster;