Object.defineProperty(exports,"__esModule",{value:!0}),exports.ragSystem=void 0;let Reset="[0m",Blue="[34m",Green="[32m",Red="[31m",Yellow="[33m",Magenta="[35m",Italic="[3m",Underscore="[4m",Cyan="[36m",Gray="[90m",hf_transformers_1=require("@langchain/community/embeddings/hf_transformers"),output_parsers_1=require("@langchain/core/output_parsers"),prompts_1=require("@langchain/core/prompts"),langgraph_1=require("@langchain/langgraph"),groq_1=require("@langchain/groq"),notionapi_1=require("@langchain/community/document_loaders/web/notionapi"),config_1=require("./config"),prompts_2=require("@langchain/core/prompts"),config_2=require("./config"),text_splitter_1=require("langchain/text_splitter"),memory_1=require("langchain/vectorstores/memory"),botPrompts_1=require("./botPrompts"),TokenLimiter_1=require("./TokenLimiter");class RAGSystem{constructor(){this.vectorStore=null,this.graph=null,this.ragApp=null,this.initializeGraph(),this.docsLoaded=!1,this.docsLoading=!1,this.vectorStore=new memory_1.MemoryVectorStore(new hf_transformers_1.HuggingFaceTransformersEmbeddings({model:"Xenova/all-MiniLM-L6-v2"})),this.tokenRateLimiter=new TokenLimiter_1.TokenRateLimiter({"llama3-8b-8192":3e4})}initializeGraph(){this.graph=new langgraph_1.StateGraph({channels:{question:null,generatedAnswer:null,documents:{value:(e,o)=>o,default:()=>[]},model:null,jsonResponseModel:null}}).addNode("retrieve_docs",this.retrieveDocs.bind(this)).addNode("create_model",this.createModel.bind(this)).addNode("create_json_response_model",this.createJsonResponseModel.bind(this)).addNode("grade_documents",this.gradeDocuments.bind(this)).addNode("generate_answer",this.generateAnswer.bind(this)).addNode("grade_answer",this.gradeAnswer.bind(this)).addEdge(langgraph_1.START,"retrieve_docs").addEdge("retrieve_docs","create_model").addEdge("create_model","create_json_response_model").addEdge("create_json_response_model","grade_documents").addConditionalEdges("grade_documents",this.hasRelevantDocs.bind(this),{yes:"generate_answer",no:langgraph_1.END}).addEdge("generate_answer","grade_answer").addEdge("grade_answer",langgraph_1.END),this.ragApp=this.graph.compile({checkpointer:new langgraph_1.MemorySaver})}async createModel(e){return{model:new groq_1.ChatGroq({model:config_2.RAGLLMModel,temperature:.1,apiKey:process.env.GROQ_API_KEY})}}async createJsonResponseModel(e){return{jsonResponseModel:new groq_1.ChatGroq({model:config_2.JSONLLMModel,temperature:0,apiKey:process.env.GROQ_API_KEY}).bind({response_format:{type:"json_object"}})}}waitForDocumentsToLoad(){return new Promise(e=>{let o=setInterval(()=>{this.docsLoaded&&(clearInterval(o),e())},100)})}async buildVectorStore(){if(!this.docsLoaded)if(this.docsLoading)await this.waitForDocumentsToLoad();else{this.docsLoading=!0;var e=config_1.NOTION_PAGE_IDS,e=await Promise.all(e.map(e=>{var o=new RegExp(/(?<!=)[0-9a-f]{32}/),e=e.match(o);if(e&&0<e.length)return o=e[0],new notionapi_1.NotionAPILoader({clientOptions:{auth:config_1.NOTION_INTEGRATION_TOKEN},id:o,type:"page"}).load()})),e=await text_splitter_1.RecursiveCharacterTextSplitter.fromLanguage("markdown",{chunkSize:500,chunkOverlap:0}).splitDocuments(e.flat());try{this.vectorStore=await memory_1.MemoryVectorStore.fromDocuments(e,new hf_transformers_1.HuggingFaceTransformersEmbeddings({model:"Xenova/all-MiniLM-L6-v2"})),this.docsLoaded=!0}catch(e){console.error("HuggingFaceTransformersEmbeddings"),console.dir(e),this.docsLoaded=!1}this.docsLoading=!1}return this.vectorStore}async retrieveDocs(e){return{documents:await(await this.buildVectorStore()).asRetriever().invoke(e.question)}}async gradeDocuments(t){var e=t.documents;let r=prompts_1.ChatPromptTemplate.fromTemplate(botPrompts_1.GRADER_TEMPLATE).pipe(t.jsonResponseModel);e=e.map(async e=>{var o=await r.invoke({document:e.pageContent,question:t.question});return JSON.parse(o.content).relevant?e:null}),e=(await Promise.all(e)).filter(Boolean);return console.log(""),e.forEach(e=>{e&&(console.log(Yellow+("Title: "+e.metadata.properties.title)+Reset),console.log(""+e.pageContent),console.log(""),console.log(""))}),console.log("----------------------------"),console.log(""),{documents:e}}hasRelevantDocs(e){return 0<e.documents.length?"yes":"no"}async generateAnswer(e){var o=botPrompts_1.TOM_SECRETARY,o=new prompts_2.PromptTemplate({template:o,inputVariables:["question","context"]}).pipe(e.model).pipe(new output_parsers_1.StringOutputParser),t=e.documents.map(e=>e.pageContent).join("\n").replace(/###.*\n/g,"").trim(),o=await o.invoke({context:t,question:e.question});return console.log(""),console.log("----- SECRETARY ANSWER ------"),console.log(Green+"Q: "+e.question+Reset),console.log(Cyan+"A: "+o+Reset),console.log("----------------------------"),console.log(""),{generatedAnswer:o}}async gradeAnswer(e){var o=await prompts_1.ChatPromptTemplate.fromTemplate(botPrompts_1.ANSWER_GRADER_TEMPLATE).pipe(e.jsonResponseModel).invoke({question:e.question,answer:e.generatedAnswer});return JSON.parse(o.content).relevant?{generatedAnswer:e.generatedAnswer}:{generatedAnswer:botPrompts_1.SORRY_UNABLE_HELP}}async preloadDocuments(){return(await this.buildVectorStore()).memoryVectors.length}async invokeRAG(e,o){return this.ragApp?await this.ragApp.invoke({question:o},{configurable:{thread_id:crypto.randomUUID()}}):(console.error("RAG app is not initialized"),"")}}exports.ragSystem=new RAGSystem;