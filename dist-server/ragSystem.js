var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ragSystem=void 0;let Reset="[0m",Blue="[34m",Green="[32m",Red="[31m",Yellow="[33m",Magenta="[35m",Italic="[3m",Underscore="[4m",Cyan="[36m",Gray="[90m",hf_transformers_1=require("@langchain/community/embeddings/hf_transformers"),output_parsers_1=require("@langchain/core/output_parsers"),prompts_1=require("@langchain/core/prompts"),langgraph_1=require("@langchain/langgraph"),groq_1=require("@langchain/groq"),notionapi_1=require("@langchain/community/document_loaders/web/notionapi"),config_1=require("./config"),prompts_2=require("@langchain/core/prompts"),config_2=require("./config"),text_splitter_1=require("langchain/text_splitter"),memory_1=require("langchain/vectorstores/memory"),botPrompts_1=require("./botPrompts"),TokenLimiter_1=require("./TokenLimiter"),FileLogger_1=__importDefault(require("./lib/FileLogger"));class RAGSystem{constructor(){this.vectorStore=null,this.graph=null,this.ragApp=null,this.initializeGraph(),this.docsLoaded=!1,this.docsLoading=!1,this.logSecretary=new FileLogger_1.default({folder:"./logs-messages",printconsole:!0}),this.vectorStore=new memory_1.MemoryVectorStore(new hf_transformers_1.HuggingFaceTransformersEmbeddings({model:"Xenova/all-MiniLM-L6-v2"})),this.tokenRateLimiter=new TokenLimiter_1.TokenRateLimiter({"llama3-8b-8192":3e4})}initializeGraph(){this.graph=new langgraph_1.StateGraph({channels:{question:null,generatedAnswer:null,documents:{value:(e,t)=>t,default:()=>[]},model:null,jsonResponseModel:null}}).addNode("retrieve_docs",this.retrieveDocs.bind(this)).addNode("create_model",this.createModel.bind(this)).addNode("create_json_response_model",this.createJsonResponseModel.bind(this)).addNode("grade_documents",this.gradeDocuments.bind(this)).addNode("generate_answer",this.generateAnswer.bind(this)).addNode("grade_answer",this.gradeAnswer.bind(this)).addEdge(langgraph_1.START,"retrieve_docs").addEdge("retrieve_docs","create_model").addEdge("create_model","create_json_response_model").addEdge("create_json_response_model","grade_documents").addConditionalEdges("grade_documents",this.hasRelevantDocs.bind(this),{yes:"generate_answer",no:langgraph_1.END}).addEdge("generate_answer","grade_answer").addEdge("grade_answer",langgraph_1.END),this.ragApp=this.graph.compile({checkpointer:new langgraph_1.MemorySaver})}async createModel(e){return{model:new groq_1.ChatGroq({model:config_2.RAGLLMModel,temperature:.1,apiKey:process.env.GROQ_API_KEY})}}async createJsonResponseModel(e){return{jsonResponseModel:new groq_1.ChatGroq({model:config_2.JSONLLMModel,temperature:0,apiKey:process.env.GROQ_API_KEY}).bind({response_format:{type:"json_object"}})}}waitForDocumentsToLoad(){return new Promise(e=>{let t=setInterval(()=>{this.docsLoaded&&(clearInterval(t),e())},100)})}async buildVectorStore(){if(!this.docsLoaded)if(this.docsLoading)await this.waitForDocumentsToLoad();else{this.docsLoading=!0;var e=config_1.NOTION_PAGE_IDS,e=await Promise.all(e.map(e=>{var t=new RegExp(/(?<!=)[0-9a-f]{32}/),e=e.match(t);if(e&&0<e.length)return t=e[0],new notionapi_1.NotionAPILoader({clientOptions:{auth:config_1.NOTION_INTEGRATION_TOKEN},id:t,type:"page"}).load()})),e=await text_splitter_1.RecursiveCharacterTextSplitter.fromLanguage("markdown",{chunkSize:500,chunkOverlap:0}).splitDocuments(e.flat());try{this.vectorStore=await memory_1.MemoryVectorStore.fromDocuments(e,new hf_transformers_1.HuggingFaceTransformersEmbeddings({model:"Xenova/all-MiniLM-L6-v2"})),this.docsLoaded=!0}catch(e){console.error("HuggingFaceTransformersEmbeddings"),console.dir(e),this.docsLoaded=!1}this.docsLoading=!1}return this.vectorStore}async retrieveDocs(e){return{documents:await(await this.buildVectorStore()).asRetriever().invoke(e.question)}}async gradeDocuments(r){var e=r.documents;let o=prompts_1.ChatPromptTemplate.fromTemplate(botPrompts_1.GRADER_TEMPLATE).pipe(r.jsonResponseModel);e=e.map(async e=>{var t=await o.invoke({document:e.pageContent,question:r.question});return JSON.parse(t.content).relevant?e:null}),e=(await Promise.all(e)).filter(Boolean);let t="RAG";return this.logSecretary.log("",t),this.logSecretary.log(`----- RETRIVED ${e.length} DOCUMENTS ------`,t),this.logSecretary.log("For: "+r.question,t),this.logSecretary.log("",t),e.forEach(e=>{e&&(this.logSecretary.log(Yellow+("Title: "+e.metadata.properties.title)+Reset,t),this.logSecretary.log(""+e.pageContent,t),this.logSecretary.log("--------",t),this.logSecretary.log("",t))}),this.logSecretary.log("----------------------------",t),{documents:e}}hasRelevantDocs(e){return 0<e.documents.length?"yes":"no"}async generateAnswer(e){var t=botPrompts_1.TOM_SECRETARY,t=new prompts_2.PromptTemplate({template:t,inputVariables:["question","context"]}).pipe(e.model).pipe(new output_parsers_1.StringOutputParser),r=e.documents.map(e=>e.pageContent).join("\n").replace(/###.*\n/g,"").trim(),t=await t.invoke({context:r,question:e.question}),r="RAG";return this.logSecretary.log("",r),this.logSecretary.log("----- SECRETARY ASSIST ------",r),this.logSecretary.log(Green+"Q: "+e.question+Reset,r),this.logSecretary.log(Cyan+"A: "+t+Reset,r),this.logSecretary.log("----------------------------",r),{generatedAnswer:t}}async gradeAnswer(e){var t=await prompts_1.ChatPromptTemplate.fromTemplate(botPrompts_1.ANSWER_GRADER_TEMPLATE).pipe(e.jsonResponseModel).invoke({question:e.question,answer:e.generatedAnswer});return JSON.parse(t.content).relevant?{generatedAnswer:e.generatedAnswer}:{generatedAnswer:botPrompts_1.SORRY_UNABLE_HELP}}async preloadDocuments(){return(await this.buildVectorStore()).memoryVectors.length}async invokeRAG(e,t){return this.ragApp?await this.ragApp.invoke({question:t},{configurable:{thread_id:crypto.randomUUID()}}):(console.error("RAG app is not initialized"),"")}}exports.ragSystem=new RAGSystem;